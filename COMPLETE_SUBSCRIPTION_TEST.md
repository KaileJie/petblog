# âœ… å®Œæ•´è®¢é˜…æµç¨‹æµ‹è¯•æŒ‡å—

## ğŸ¯ æµ‹è¯•ç›®æ ‡

éªŒè¯æ•´ä¸ªè®¢é˜…æµç¨‹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ŒåŒ…æ‹¬ï¼š
1. âœ… åˆ›å»º checkout session
2. âœ… å®Œæˆæ”¯ä»˜
3. âœ… Webhook å¤„ç†è®¢é˜…äº‹ä»¶
4. âœ… æ•°æ®åº“è®°å½•æ­£ç¡®åˆ›å»º
5. âœ… ç”¨æˆ·èƒ½å¤Ÿè®¿é—® dashboard

---

## ğŸ“‹ æµ‹è¯•æ­¥éª¤

### æ­¥éª¤ 1: å®Œæˆè®¢é˜…æ”¯ä»˜

1. **è®¿é—®è®¢é˜…é¡µé¢**
   - æ‰“å¼€ï¼š`http://localhost:3000/subscribe`
   - ç¡®ä¿å·²ç™»å½•ï¼ˆä½¿ç”¨æ–°æ³¨å†Œçš„è´¦å·ï¼‰

2. **ç‚¹å‡» "Subscribe Now"**
   - âœ… åº”è¯¥èƒ½æ­£å¸¸åˆ›å»º checkout sessionï¼ˆä¸å†æœ‰ 404 é”™è¯¯ï¼‰
   - âœ… åº”è¯¥é‡å®šå‘åˆ° Stripe Checkout é¡µé¢

3. **å®Œæˆæ”¯ä»˜**
   - ä½¿ç”¨ Stripe æµ‹è¯•å¡ï¼š
     - **å¡å·ï¼š** `4242 4242 4242 4242`
     - **è¿‡æœŸæ—¥æœŸï¼š** ä»»æ„æœªæ¥æ—¥æœŸï¼ˆå¦‚ `12/25`ï¼‰
     - **CVCï¼š** ä»»æ„ 3 ä½æ•°å­—ï¼ˆå¦‚ `123`ï¼‰
     - **é‚®ç¼–ï¼š** ä»»æ„é‚®ç¼–ï¼ˆå¦‚ `12345`ï¼‰
   - ç‚¹å‡» "Subscribe"

4. **ç­‰å¾…é‡å®šå‘**
   - âœ… åº”è¯¥é‡å®šå‘åˆ°ï¼š`/dashboard?session_id=cs_test_...`
   - âœ… åº”è¯¥çœ‹åˆ° "Verifying your subscription..." æˆ–ç›´æ¥æ˜¾ç¤º dashboard

---

### æ­¥éª¤ 2: éªŒè¯æ•°æ®åº“è®°å½•

1. **è®¿é—® Supabase Dashboard**
   - https://supabase.com/dashboard/project/wqinxqlsmoroqgqpdjfk/editor

2. **æ£€æŸ¥ `subscriptions` è¡¨**
   - æ‰“å¼€ `subscriptions` è¡¨
   - æŸ¥æ‰¾ä½ çš„ç”¨æˆ· IDï¼ˆ`user_id`ï¼‰
   - âœ… åº”è¯¥çœ‹åˆ°æ–°çš„è®¢é˜…è®°å½•
   - âœ… æ£€æŸ¥ä»¥ä¸‹å­—æ®µï¼š
     - `stripe_subscription_id` - åº”è¯¥ä»¥ `sub_` å¼€å¤´
     - `stripe_customer_id` - åº”è¯¥ä»¥ `cus_` å¼€å¤´
     - `status` - åº”è¯¥æ˜¯ `active`
     - `price_id` - åº”è¯¥æœ‰å€¼
     - `current_period_start` å’Œ `current_period_end` - åº”è¯¥æœ‰æ—¥æœŸ

3. **æ£€æŸ¥ `profiles` è¡¨**
   - æ‰“å¼€ `profiles` è¡¨
   - âœ… ç¡®è®¤ä½ çš„ç”¨æˆ·è®°å½•å­˜åœ¨
   - âœ… `email` å­—æ®µæ­£ç¡®

---

### æ­¥éª¤ 3: æ£€æŸ¥ Webhook æ—¥å¿—

1. **è®¿é—® stripe-webhook å‡½æ•°æ—¥å¿—**
   - https://supabase.com/dashboard/project/wqinxqlsmoroqgqpdjfk/functions/stripe-webhook/logs

2. **æŸ¥çœ‹æœ€æ–°æ—¥å¿—**
   - âœ… åº”è¯¥çœ‹åˆ°å¤šä¸ª webhook äº‹ä»¶è¢«å¤„ç†ï¼š
     - `checkout.session.completed`
     - `customer.subscription.created`
     - `customer.subscription.updated`
     - `invoice.payment_succeeded`

3. **éªŒè¯æ²¡æœ‰é”™è¯¯**
   - âŒ **ä¸åº”è¯¥çœ‹åˆ°ï¼š** `No subscription found: sub_xxx`
   - âœ… **åº”è¯¥çœ‹åˆ°ï¼š** æˆåŠŸå¤„ç†çš„æ—¥å¿—
   - âœ… å¦‚æœä¹‹å‰æ²¡æœ‰ subscription è®°å½•ï¼Œåº”è¯¥çœ‹åˆ°ï¼š`Creating missing subscription record for sub_xxx with user_id xxx`

---

### æ­¥éª¤ 4: éªŒè¯ Dashboard è®¿é—®

1. **è®¿é—® Dashboard**
   - æ‰“å¼€ï¼š`http://localhost:3000/dashboard`
   - âœ… åº”è¯¥èƒ½æ­£å¸¸è®¿é—®ï¼ˆä¸å†é‡å®šå‘åˆ° `/subscribe`ï¼‰
   - âœ… åº”è¯¥çœ‹åˆ° dashboard å†…å®¹

2. **æ£€æŸ¥è®¢é˜…çŠ¶æ€**
   - âœ… Dashboard åº”è¯¥æ˜¾ç¤ºè®¢é˜…å·²æ¿€æ´»
   - âœ… åº”è¯¥èƒ½çœ‹åˆ° premium åŠŸèƒ½

---

### æ­¥éª¤ 5: æµ‹è¯•è¾¹ç¼˜æƒ…å†µï¼ˆå¯é€‰ï¼‰

#### æµ‹è¯• A: å·²è®¢é˜…ç”¨æˆ·è®¿é—®è®¢é˜…é¡µé¢

1. **è®¿é—® `/subscribe` é¡µé¢**
   - âœ… åº”è¯¥ç«‹å³é‡å®šå‘åˆ° `/dashboard`
   - âœ… ä¸åº”è¯¥æ˜¾ç¤ºè®¢é˜…è¡¨å•

#### æµ‹è¯• B: æ£€æŸ¥è®¢é˜…æ›´æ–°äº‹ä»¶

1. **åœ¨ Stripe Dashboard ä¸­**
   - è®¿é—®ï¼šhttps://dashboard.stripe.com/test/subscriptions
   - æ‰¾åˆ°ä½ çš„æµ‹è¯•è®¢é˜…
   - æ‰‹åŠ¨è§¦å‘æ›´æ–°ï¼ˆå¦‚ä¿®æ”¹è®¢é˜…ï¼‰

2. **æ£€æŸ¥ webhook æ—¥å¿—**
   - âœ… åº”è¯¥çœ‹åˆ° `customer.subscription.updated` äº‹ä»¶è¢«æ­£ç¡®å¤„ç†
   - âœ… ä¸åº”è¯¥çœ‹åˆ° "No subscription found" é”™è¯¯

---

## âœ… æˆåŠŸæ ‡å‡†

å®Œæˆæ‰€æœ‰æµ‹è¯•åï¼Œç¡®è®¤ï¼š

- [ ] âœ… è®¢é˜…æµç¨‹å®Œæ•´æ— é”™è¯¯
- [ ] âœ… Checkout session æˆåŠŸåˆ›å»º
- [ ] âœ… æ”¯ä»˜æˆåŠŸå®Œæˆ
- [ ] âœ… æ•°æ®åº“ä¸­æœ‰æ­£ç¡®çš„ subscription è®°å½•
- [ ] âœ… Webhook æ­£ç¡®å¤„ç†æ‰€æœ‰äº‹ä»¶
- [ ] âœ… **æ²¡æœ‰ "No subscription found" é”™è¯¯**
- [ ] âœ… ç”¨æˆ·èƒ½å¤Ÿè®¿é—® dashboard
- [ ] âœ… å·²è®¢é˜…ç”¨æˆ·æ­£ç¡®é‡å®šå‘

---

## ğŸ” å¦‚æœå‡ºç°é—®é¢˜

### é—®é¢˜ 1: Webhook ä»æœ‰ "No subscription found" é”™è¯¯

**æ£€æŸ¥ï¼š**
- æŸ¥çœ‹ webhook æ—¥å¿—ä¸­çš„å®Œæ•´é”™è¯¯ä¿¡æ¯
- ç¡®è®¤ subscription metadata ä¸­æ˜¯å¦æœ‰ `supabase_user_id`
- æ£€æŸ¥ customer metadata ä¸­æ˜¯å¦æœ‰ `supabase_user_id`

**è§£å†³ï¼š**
- ä»£ç å·²ä¿®å¤ï¼Œåº”è¯¥èƒ½è‡ªåŠ¨å¤„ç†
- å¦‚æœä»æœ‰é—®é¢˜ï¼Œæ£€æŸ¥ Stripe ä¸­çš„ metadata è®¾ç½®

### é—®é¢˜ 2: è®¢é˜…è®°å½•æœªåˆ›å»º

**æ£€æŸ¥ï¼š**
- Webhook æ—¥å¿—ä¸­æ˜¯å¦æœ‰é”™è¯¯
- æ•°æ®åº“ RLS ç­–ç•¥æ˜¯å¦æ­£ç¡®
- Stripe webhook endpoint æ˜¯å¦æ­£ç¡®é…ç½®

**è§£å†³ï¼š**
- æ£€æŸ¥ webhook secret æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ webhook endpoint URL æ­£ç¡®

### é—®é¢˜ 3: Dashboard æ— æ³•è®¿é—®

**æ£€æŸ¥ï¼š**
- è®¢é˜…è®°å½•æ˜¯å¦å·²åˆ›å»º
- è®¢é˜…çŠ¶æ€æ˜¯å¦ä¸º `active`
- æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰é”™è¯¯

**è§£å†³ï¼š**
- æ£€æŸ¥æ•°æ®åº“ä¸­çš„ subscription è®°å½•
- ç¡®è®¤ `status` å­—æ®µä¸º `active`

---

## ğŸ“Š æµ‹è¯•ç»“æœè®°å½•

å®Œæˆæµ‹è¯•åï¼Œè®°å½•ä»¥ä¸‹ä¿¡æ¯ï¼š

- âœ… è®¢é˜…åˆ›å»ºæ—¶é—´ï¼š___________
- âœ… Stripe Subscription IDï¼š___________
- âœ… Database Subscription IDï¼š___________
- âœ… Webhook äº‹ä»¶æ•°é‡ï¼š___________
- âœ… æ˜¯å¦æœ‰é”™è¯¯ï¼šæ˜¯ / å¦
- âœ… é”™è¯¯è¯¦æƒ…ï¼ˆå¦‚æœæœ‰ï¼‰ï¼š___________

---

**å¼€å§‹æµ‹è¯•ï¼šæŒ‰ç…§ä¸Šè¿°æ­¥éª¤é€ä¸€éªŒè¯ï¼Œç¡®ä¿æ•´ä¸ªè®¢é˜…æµç¨‹æ­£å¸¸å·¥ä½œï¼** ğŸ‰

